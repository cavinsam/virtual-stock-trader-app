---
# Kubernetes deployment orchestration tasks

- name: Set deployment facts
  set_fact:
    k8s_namespace: "virtual-stock-trader"
    k8s_manifest_dir: "k8s"

- name: Ensure kubectl is available
  command: which kubectl
  register: kubectl_check
  failed_when: kubectl_check.rc != 0
  changed_when: false

- name: Create namespace
  kubernetes.core.k8s:
    name: "{{ k8s_namespace }}"
    api_version: v1
    kind: Namespace
    state: present

- name: Deploy manifests using kustomize
  kubernetes.core.k8s:
    namespace: "{{ k8s_namespace }}"
    definition: "{{ lookup('kubernetes.core.kustomize', {{ ansible_user_dir }}/{{ k8s_manifest_dir }}) }}"
    state: present
  register: k8s_deploy_result

- name: Wait for MySQL pod to be ready
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ k8s_namespace }}"
    label_selectors:
      - app=mysql
    wait: yes
    wait_condition:
      type: Ready
      status: 'True'
    wait_sleep: 5
    wait_timeout: 120
  register: mysql_pod

- name: Wait for frontend deployment to be ready
  kubernetes.core.k8s_info:
    kind: Deployment
    namespace: "{{ k8s_namespace }}"
    name: frontend
    wait: yes
    wait_condition:
      type: Available
      status: 'True'
    wait_sleep: 5
    wait_timeout: 300
  register: frontend_deployment

- name: Wait for backend deployment to be ready (extended timeout)
  kubernetes.core.k8s_info:
    kind: Deployment
    namespace: "{{ k8s_namespace }}"
    name: backend
    wait: yes
    wait_condition:
      type: Available
      status: 'True'
    wait_sleep: 10
    wait_timeout: 600
  register: backend_deployment
  ignore_errors: yes

- name: Verify deployments
  kubernetes.core.k8s_info:
    kind: Deployment
    namespace: "{{ k8s_namespace }}"
  register: all_deployments

- name: Display deployment status
  debug:
    msg: "Deployment {{ item.metadata.name }}: {{ item.status.readyReplicas }}/{{ item.spec.replicas }} replicas ready"
  loop: "{{ all_deployments.resources }}"
  when: all_deployments.resources is defined
